<!-- NOTE this code CAN BE out of date with regards to "FirebaseAccess.js" functionality 
    Please see "FirebaseAccess.js" or documentation for updated parameter passing
-->

<!-- This file is meant to be an example file for debugging firebase code. In reality this file is the combonation of "'HTML Firebase stucture Example'.html" and "FirebaseAccess.js" .
  With this structure, a local server is not nessary for varification of functionality. 

  For front-end purposes: it may be nesssary to follow this file structure inorder to develop HTML site pages that use Firebase commands if you do not want to set up a local server as per
  the comment in "'HTML Firebase stucture Example'.html". However the structure discribed by "'HTML Firebase stucture Example'.html" should be followed for pushing to the git repo
-->
<!DOCTYPE html>
<html>

<body>

  <form id="form1">
    <label for="UID">UserID:</label>
    <input type="text" id="UID" name="UID"><br><br>
    <label for="name">name:</label>
    <input type="text" id="name" name="name"><br><br>
    <label for="password">password:</label>
    <input type="text" id="password" name="password"><br><br>
    <label for="accessLevel">access Level:</label>
    <input type="text" id="accessLevel" name="accessLevel"><br><br>
    <input type="button" value="Submit" id="submit">
  </form>

  <button id="getUser">search id</button>
  <button id="updateUser">update</button>
  <button id="deleteUser">delete</button>
  <form>
    <label for="idDisplay">UserID:</label>
    <label id="idDisplay" name="idDisplay"></label><br><br>
    <label for="nameDisplay">name:</label>
    <label id="nameDisplay" name="nameDisplay"></label><br><br>
    <label for="accessLevelDisplay">access Level:</label>
    <label id="accessLevelDisplay" name="accessLevelDisplay"></label><br><br>
  </form>


  <script>

    function display(id, data) {
      document.getElementById("idDisplay").textContent = id;
      document.getElementById("nameDisplay").textContent = data.Name;
      document.getElementById("accessLevelDisplay").textContent = data.AccessLevel;
    }

  </script>

  <!-- For front-end: Suppose you are testing a display function after fetching some data from the database,
    then you can the imports that you will need would be  
      import { getDatabase, ref, set, onValue, get, child } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";
      import { getStorage } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js";
    from "FirebaseAccess.js" and the respective functions
    Be sure to include line 7 to 20 from "FirebaseAccess.js" after your imports but before code for functions, as without it Firebase Operation will not work without it
  -->
  <script type="module">
    document.getElementById("submit").addEventListener('click', adder);
    document.getElementById("getUser").addEventListener('click', searcher);
    document.getElementById("updateUser").addEventListener('click', updater);
    document.getElementById("deleteUser").addEventListener('click', deleteID);


    function searcher() {
      const uid = document.getElementById("UID").value;
      userSearch(uid, display)

    }

    function adder() {
      const UID = document.getElementById("UID").value;
      const name = document.getElementById("name").value;
      const al = document.getElementById("accessLevel").value;
      const pass = document.getElementById("password").value;
      userAdd(UID, name, al, pass)
    }

    function updater() {
      const UID = document.getElementById("UID").value;
      const name = document.getElementById("name").value;
      const al = document.getElementById("accessLevel").value
      userUpdate(UID, "Name", name)
      userUpdate(UID, "AccessLevel", al)
      //or
      userUpdateMany(UID, ["Name", "AccessLevel"], [name, al]);
    }

    function deleteID() {
      const UID = document.getElementById("UID").value;
      userDeleter(UID)
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
    import { getDatabase, ref, set, onValue, get, child } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCm9-YxifpEbVuBYOh3GukLka4cenJYw84",
      authDomain: "cosc4p02-mesuemmap.firebaseapp.com",
      projectId: "cosc4p02-mesuemmap",
      storageBucket: "cosc4p02-mesuemmap.appspot.com",
      messagingSenderId: "235500180144",
      appId: "1:235500180144:web:6b3bf1fb3ff3c50c80a175",
      databaseURL: "https://cosc4p02-mesuemmap-default-rtdb.firebaseio.com/"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase();
    const storage = getStorage(app);

    //entry functionality
    /**
     * Uses the following parameters to create an entry into the "exhibit" database while uploading and link supplied images
     * @param {*} ID ID refrence for the exhibit
     * @param {string} title 
     * @param {string} date 
     * @param {string} floor floor which the exhibit resides 
     * @param {File[]} images
     * @param {string} description 
     */
    export function entryAdd(ID, title, date, floor, images, description) {
      addEntry(ID, title, date, floor, images, discription);
    }
    /**
     * Updates a single field of an entry with some new data
     * @param {*} ID ID refrence for the entry
     * @param {string} fieldToUpdate 
     * @param {string} newData 
     */
    export function entryUpdate(ID, fieldToUpdate, newData) {
      updateEntry(ID, fieldToUpdate, newData);
    }
    /**
     * Updates many fields of an entry with some new data
     * @param {*} ID ID reference for the entry
     * @param {string[]} feildsToUpdate 
     * @param {*} newData 
     */
    export function entryUpdateMany(ID, feildsToUpdate, newData) {
      feildsToUpdate.array.forEach((element, index) => {
        updateEntry(ID, element, newData[index]);
      });
    }
    /**
     * fetches a single entry based on a supplied ID
     * @param {*} ID ID reference for the entry
     * @param {function} callbackFunction a function that will handle the results of a search, typically for displaying the results
     */
    export function entrySearch(ID, callbackFunction) {
      searchEntries(ID, callbackFunction);
    }
    /**
     * Deletes a specified entry
     * @param {*} ID ID referencereferencereferencereferencereference for the entry
     */
    export function entryDelete(ID) {
      deleteEntry(ID);
    }

    function addEntry(id, title, date, floor, images, description) {
      const reference = ref(database);
      get(child(reference, 'Exhibits/' + id)).then((snapshot) => {
        if (snapshot.exists()) {
          alert("Exhibit Id is currently in use, Please choose a new ID");
        } else {

          //upload images and create array for names (refrence)
          const imageNames = [];
          for (let i = 0; i < images.length; i++) {
            const element = images[i];
            imageNames[i] = element.name;
            imageAdd(element);
          }

          //add data to database including imageNames
          const reference = ref(database, 'Exhibits/' + id);
          set(reference, { Title: title, Date: date, Floor: floor, Images: imageNames, Desc: description }).then(() => {
            alert("Exhibit has been added");
          }).catch((error) => {
            alert("An error occured \n Code:" + error.code);
          });
        }
      });
    }

    function searchEntries(id, callbackFunction) {
      const reference = ref(database);
      get(child(reference, 'Exhibits/' + id)).then((snapshot) => {
        if (snapshot.exists()) {
          const entry = snapshot.val();
          callbackFunction(id, entry);
        } else {
          alert("No entry is asocatied with Id:" + id);
        }
      }).catch((error) => {
        console.error(error);
      })
    }

    function updateEntry(ID, fieldToUpdate, newData) {
      const reference = ref(database);
      get(child(reference, 'Exhibits/' + ID)).then((snapshot) => {
        if (snapshot.exists()) {
          const reference = ref(database, 'Exhibits/' + ID + "/" + fieldToUpdate);
          set(reference, newData).then(() => {
            alert("ID:" + ID + " " + fieldToUpdate + " has been updated to: " + newData);
          }).catch((error) => {
            alert("An error occured \n Code:" + error.code);
          });
        } else {
          alert("No entry is asocatied with Id:" + ID);
        }
      });
    }

    function deleteEntry(ID) {
      const reference = ref(database);
      get(child(reference, 'Exhibits/' + ID)).then((snapshot) => {
        if (snapshot.exists()) {
          const reference = ref(database, "Exhibits/" + id);
          set(reference, null).then(() => {
            alert("Entry with ID:" + id + " has been deleted")
          }).catch((error) => {
            alert("An error occured \n Code:" + error.code);
          })
        } else {
          alert("No entry is asocatied with Id:" + id);
        }
      })
    }



    // User functionality
    /**
     * Deletes a specified user
     * @param {*} ID ID referencereference for the user
     */
    export function userDeleter(UID) {
      deleteUser(UID);
    }
    /**
     * Updates a single field of a user with some new data
     * @param {*} ID ID reference for the user
     * @param {string} fieldToUpdate 
     * @param {string} newData 
     */
    export function userUpdate(UID, fieldToUpdate, newData) {
      updateUser(UID, fieldToUpdate, newData);
    }
    /**
     * Updates many fields of a user with some new data
     * @param {*} ID ID refrence for the user
     * @param {string[]} feildsToUpdate 
     * @param {string[]} newData 
     */
    export function userUpdateMany(ID, feildsToUpdate, newData) {
      feildsToUpdate.forEach((element, index) => {
        updateUser(ID, element, newData[index]);
      });
    }
    /**
     * fetches a single user based on a supplied ID
     * @param {*} ID ID reference for the user
     * @param {function} callbackFunction a function that will handle the results of a search, typically for displaying the results
     */
    export function userSearch(UID, callbackFunction) {
      searchUsers(UID, callbackFunction);
    }
    /**
     * Uses the following parameters to create a user into the "users" database
     * @param {*} UID ID reference 
     * @param {string} name 
     * @param {string} accessLevel Access level of the user
     * @param {string} password
     */
    export function userAdd(UID, name, accessLevel, password) {
      addUser(UID, name, accessLevel, password);
    }

    function addUser(id, name, accessLevel, password) {
      const reference = ref(database);
      get(child(reference, 'users/' + id)).then((snapshot) => {
        if (snapshot.exists()) {
          alert("User Id is currently in use, Please choose a new ID");
        } else {
          const reference = ref(database, 'users/' + id);
          set(reference, { Name: name, AccessLevel: accessLevel, Password: password }).then(() => {
            alert("User has been added");
          }).catch((error) => {
            alert("An error occured \n Code:" + error.code);
          });
        }
      });
    }
    function searchUsers(id, callbackFunction) {
      const reference = ref(database);
      get(child(reference, 'users/' + id)).then((snapshot) => {
        if (snapshot.exists()) {
          const user = snapshot.val();
          callbackFunction(id, user);
        } else {
          alert("No account is asocatied with Id:" + id);
        }
      }).catch((error) => {
        console.error(error);
      })
    }
    function updateUser(id, fieldToUpdate, newData) {
      const reference = ref(database);
      get(child(reference, 'users/' + id)).then((snapshot) => {
        if (snapshot.exists()) {
          const reference = ref(database, 'users/' + id + "/" + fieldToUpdate)
          set(reference, newData).then(() => {
            alert("ID:" + id + " " + fieldToUpdate + " has been updated to: " + newData);
          }).catch((error) => {
            alert("An error occured \n Code:" + error.code);
          });
        } else {
          alert("No account is asocatied with Id:" + id);
        }
      });
    }
    function deleteUser(id) {
      const reference = ref(database);
      get(child(reference, 'users/' + id)).then((snapshot) => {
        if (snapshot.exists()) {
          const reference = ref(database, "users/" + id);
          set(reference, null).then(() => {
            alert("User with ID:" + id + " has been deleted")
          }).catch((error) => {
            alert("An error occured \n Code:" + error.code);
          })
        } else {
          alert("No account is asocatied with Id:" + id);
        }
      })
    }

  </script>
</body>

</html>