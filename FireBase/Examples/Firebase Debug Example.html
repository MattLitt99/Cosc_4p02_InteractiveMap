<!-- NOTE this code CAN BE out of date with regards to "FirebaseAccess.js" functionality 
    Please see "FirebaseAccess.js" or documentation for updated parameter passing
-->

<!-- This file is meant to be an example file for debugging firebase code. In reality this file is the combonation of "'HTML Firebase stucture Example'.html" and "FirebaseAccess.js" .
  With this structure, a local server is not nessary for varification of functionality. 

  For front-end purposes: it may be nesssary to follow this file structure inorder to develop HTML site pages that use Firebase commands if you do not want to set up a local server as per
  the comment in "'HTML Firebase stucture Example'.html". However the structure discribed by "'HTML Firebase stucture Example'.html" should be followed for pushing to the git repo
-->
<!DOCTYPE html>
<html>

<body>

  <form id="form1">
    <label for="UID">UserID:</label>
    <input type="text" id="UID" name="UID"><br><br>
    <label for="name">name:</label>
    <input type="text" id="name" name="name"><br><br>
    <label for="password">password:</label>
    <input type="text" id="password" name="password"><br><br>
    <label for="accessLevel">access Level:</label>
    <input type="text" id="accessLevel" name="accessLevel"><br><br>
    <input type="button" value="Submit" id="submit">
  </form>

  <button id="getUser">search id</button>
  <button id="updateUser">update</button>
  <button id="deleteUser">delete</button>
  <form>
    <label for="idDisplay">UserID:</label>
    <label id="idDisplay" name="idDisplay"></label><br><br>
    <label for="nameDisplay">name:</label>
    <label id="nameDisplay" name="nameDisplay"></label><br><br>
    <label for="accessLevelDisplay">access Level:</label>
    <label id="accessLevelDisplay" name="accessLevelDisplay"></label><br><br>
  </form>

  <form id="form2">
    <label for="EID">EID:</label>
    <input type="text" id="EID" name="EID"><br><br>
    <label for="title">Title:</label>
    <input type="text" id="title" name="title"><br><br>
    <label for="date">date:</label>
    <input type="text" id="date" name="date"><br><br>
    <label for="floor">floor:</label>
    <input type="text" id="floor" name="floor"><br><br>
    <label for="desc">Desc:</label>
    <input type="text" id="desc" name="desc"><br><br>
    <label for="status">status:</label>
    <input type="text" id="status" name="status"><br><br>
    <label for "imageUpload">Select Images</label>
    <input type="file" id="imageUpload" name="imageUpload" accept=".jpg, .jpeg, .png" multiple="multiple" />
    <input type="button" value="Submit" id="submit2">
  </form>
  <script>

    function display(id, data) {
      document.getElementById("idDisplay").textContent = id;
      document.getElementById("nameDisplay").textContent = data.Name;
      document.getElementById("accessLevelDisplay").textContent = data.AccessLevel;
    }

    const input = document.querySelector("#imageUpload");
    input.addEventListener('change', updateImageList);
    const imageList = [];

    function updateImageList() {
      const Images = input.files;
      for (let i = 0; i < input.files.length; i++) {
        imageList[i] = input.files[i];
      }
    }

  </script>

  <!-- For front-end: Suppose you are testing a display function after fetching some data from the database,
    then you can the imports that you will need would be  
      import { getDatabase, ref, set, onValue, get, child } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";
      import { getStorage } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js";
    from "FirebaseAccess.js" and the respective functions
    Be sure to include line 7 to 20 from "FirebaseAccess.js" after your imports but before code for functions, as without it Firebase Operation will not work without it
  -->
  <script type="module">
    document.getElementById("submit").addEventListener('click', adder);
    document.getElementById("getUser").addEventListener('click', searcher);
    document.getElementById("updateUser").addEventListener('click', updater);
    document.getElementById("deleteUser").addEventListener('click', deleteID);

    document.getElementById("submit2").addEventListener('click', addE);

    function addE() {
      const EID = document.getElementById("EID").value;
      const title = document.getElementById("title").value;
      const date = document.getElementById("date").value;
      const floor = document.getElementById("floor").value;
      const desc = document.getElementById("desc").value;
      const status = document.getElementById("status").value;
      addExhibit(EID, title, date, floor, imageList, desc, status);
    }
    function searcher() {
      const uid = document.getElementById("UID").value;
      searchUser(uid, display);

    }

    function adder() {
      const UID = document.getElementById("UID").value;
      const name = document.getElementById("name").value;
      const al = document.getElementById("accessLevel").value;
      const pass = document.getElementById("password").value;
      addUser(UID, name, al, pass)
    }

    function updater() {
      const UID = document.getElementById("UID").value;
      const name = document.getElementById("name").value;
      const al = document.getElementById("accessLevel").value
      updateUser(UID, "Name", name)
      updateUser(UID, "AccessLevel", al)
      //or
      userUpdateMany(UID, ["Name", "AccessLevel"], [name, al]);
    }

    function deleteID() {
      const UID = document.getElementById("UID").value;
      deleteUser(UID)
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getFirestore, setDoc, getDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCm9-YxifpEbVuBYOh3GukLka4cenJYw84",
      authDomain: "cosc4p02-mesuemmap.firebaseapp.com",
      projectId: "cosc4p02-mesuemmap",
      storageBucket: "cosc4p02-mesuemmap.appspot.com",
      messagingSenderId: "235500180144",
      appId: "1:235500180144:web:6b3bf1fb3ff3c50c80a175",
      databaseURL: "https://cosc4p02-mesuemmap-default-rtdb.firebaseio.com/"
    };


    const app = initializeApp(firebaseConfig);
    const database = getFirestore(app);
    const storage = getStorage(app);


    //EXHIBIT FUNCTIONALITY
    /**
     * Uses the following parameters to create an entry into the "exhibit" database while uploading and link supplied images
     * @param {*} ID
     * @param {string} title 
     * @param {string} date 
     * @param {string} floor 
     * @param {File[]} images
     * @param {string} description 
     * @param {string} status
     */
    export function entryAdd(ID, title, date, floor, images, description, status) {
      addEntry(ID, title, date, floor, images, description, status);
    }
    /**
     * Updates a single field of an exhibit with some new data
     * @param {*} ID ID refrence for the exhibit
     * @param {string} fieldToUpdate 
     * @param {*} newData 
     */
    export function entryUpdate(ID, fieldToUpdate, newData) {
      updateEntry(ID, fieldToUpdate, newData);
    }
    /**
     * Updates many fields of an exhibit with some new data
     * @param {*} ID ID reference for the exhibit
     * @param {string[]} feildsToUpdate 
     * @param {*} newData 
     */
    export function exhibitUpdateMany(ID, feildsToUpdate, newData) {
      feildsToUpdate.forEach((element, index) => {
        updateEntry(ID, element, newData[index]);
      });
    }
    /**
     * fetches a single exhibit based on a supplied ID
     * @param {*} ID ID reference for the exhibit
     * @param {function} callbackFunction a function that will handle the results of a search, typically for displaying the results
     */
    export function exhibitSearch(ID, callbackFunction) {
      searchExhibits(ID, callbackFunction);
    }
    /**
     * Deletes a specified exhibit
     * @param {*} ID ID reference for the entry
     */
    export function exhibitDelete(ID) {
      deleteExhibit(ID);
    }

    async function addExhibit(ID, title, date, floor, images, description, status) {
      const docRef = doc(database, "Exhibits", ID);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        alert("Exhibit Id is currently in use, Please choose a new ID");
      } else {
        //upload images and store names
        const imageNames = [];
        for (let i = 0; i < images.length; i++) {
          const element = images[i];
          imageNames[i] = element.name;
          imageAdd(element);
        }

        //create exhibit
        await setDoc(docRef, {
          Title: title,
          Date: date,
          Floor: floor,
          Images: imageNames,
          Desc: description,
          Satus: status
        });
        alert("Exhbit Added");
      }
    }
    async function searchExhibits(ID, callbackFunction) {
      const docRef = doc(database, "Exhibits", ID);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        callbackFunction(ID, snap.data());
      } else {
        alert("No exhibit associated with " + ID);
      }
    }
    async function updateExhibit(ID, fieldToUpdate, newData) {
      const docRef = doc(data, "Exhibits", ID);
      if (fieldToUpdate === "Title") {
        setDoc(docRef, { Title: newData }, { merge: true })
      }
      if (fieldToUpdate === "Date") {
        setDoc(docRef, { Date: newData }, { merge: true })
      }
      if (fieldToUpdate === "Floor") {
        setDoc(docRef, { Floor: newData }, { merge: true })
      }
      if (fieldToUpdate === "Images") {
        const images = newData;
        const imageNames = [];
        for (let i = 0; i < images.length; i++) {
          const element = images[i];
          imageNames[i] = element.name;
          imageAdd(element);
        }
        setDoc(docRef, { Images: imageNames }, { merge: true })
      }
      if (fieldToUpdate === "Desc") {
        setDoc(docRef, { Desc: newData }, { merge: true })
      }
      if (fieldToUpdate === "Satus") {
        setDoc(docRef, { Satus: newData }, { merge: true })
      }
    }
    async function deleteExhibit(ID) {
      const docRef = doc(data, "Exhibits", ID);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        deleteDoc(docRef);
        alert("Deleted exhibit associated with " + ID);
      } else {
        alert("No exhibit associated with " + ID);
      }
    }

    //USER FUNCTIONALITY
    /**
     * Deletes a specified user
     * @param {*} ID ID referencereference for the user
     */
    export function userDeleter(UID) {
      deleteUser(UID);
    }
    /**
     * Updates a single field of a user with some new data
     * @param {*} ID ID reference for the user
     * @param {string} fieldToUpdate 
     * @param {string} newData 
     */
    export function userUpdate(UID, fieldToUpdate, newData) {
      updateUser(UID, fieldToUpdate, newData);
    }
    /**
     * Updates many fields of a user with some new data
     * @param {*} ID ID refrence for the user
     * @param {string[]} feildsToUpdate 
     * @param {string[]} newData 
     */
    export function userUpdateMany(ID, feildsToUpdate, newData) {
      feildsToUpdate.forEach((element, index) => {
        updateUser(ID, element, newData[index]);
      });
    }
    /**
     * fetches a single user based on a supplied ID
     * @param {*} ID ID reference for the user
     * @param {function} callbackFunction a function that will handle the results of a search, typically for displaying the results
     */
    export function userSearch(UID, callbackFunction) {
      searchUser(UID, callbackFunction);
    }
    /**
     * Uses the following parameters to create a user into the "users" database
     * @param {*} UID ID reference 
     * @param {string} name 
     * @param {string} accessLevel Access level of the user
     * @param {string} password
     */
    export function userAdd(UID, name, accessLevel, password) {
      addUser(UID, name, accessLevel, password);
    }

    async function addUser(UID, name, accessLevel, password) {
      const docRef = doc(database, "users", UID);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        alert(UID + " Currently in use; Please select a new one")
      } else {
        await setDoc(docRef, {
          Name: name,
          AccessLevel: accessLevel,
          Password: password
        });
        alert("Account Created with " + UID)
      }
    }

    async function searchUser(UID, callbackfunction) {
      const docRef = doc(database, "users", UID);
      const snapshot = await getDoc(docRef);
      if (snapshot.exists()) {
        callbackfunction(UID, snapshot.data());
      } else {
        alert("No account associated with " + UID);
      }
    }

    async function deleteUser(UID) {
      const docRef = doc(database, "users", UID);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        deleteDoc(docRef);
        alert("Deleted account associated with " + UID);
      } else {
        alert("No account associated with " + UID);
      }
    }
    async function updateUser(UID, fieldToUpdate, newData) {
      const docRef = doc(database, "users", UID);
      if (fieldToUpdate === "Name") {
        setDoc(docRef, { Name: newData }, { merge: true });
      }
      if (fieldToUpdate === "AccessLevel") {
        setDoc(docRef, { AccessLevel: newData }, { merge: true })
      }
      if (fieldToUpdate === "Password") {
        setDoc(docRef, { Password: newData }, { merge: true })
      }
    }

    //IMAGE STORAGE FUNCTIONALITY
    /**
     * Uploads a single image to the image storage
     * @param {File} image image to be uploaded
     */
    export function addImage(image) {
      imageAdd(image)
    }
    /**
     * fetches a image, based on supplied name (including '.png' '.jpg' or '.jpeg') and runs a callbackfunction on it
     * @param {string} imageName 
     * @param {function} callbackFunction a function that is expecting a http url which is the link to the requested image
     */
    export function getImage(imageName, callbackFunction) {
      imageGet(imageName, callbackFunction);
    }
    /**
     * deletes a image, based on supplied name (including '.png' '.jpg' or '.jpeg')
     * @param {string} imageName 
     */
    export function deleteImage(imageName) {
      Imagedelete(imageName);
    }

    function Imagedelete(imageName) {
      const imgRef = sRef(storage, "images/" + imageName);
      deleteObject(imgRef).then(() => {
        alert(imageName + " has been deleted")
      }).catch((error) => {
        alert("Error: " + error.code + " has occured, please try again")
      });
    }

    function imageGet(imageName, callbackFunction) {
      const imgRef = sRef(storage, "images/" + imageName);
      getDownloadURL(imgRef).then((url) => {
        callbackFunction(url);
      })
    }

    function imageAdd(image) {
      const imageRef = sRef(storage, "images/" + image.name);
      uploadBytes(imageRef, image).then((snapshot) => {
        console.log(image.name + " Uploaded");
      });
    }
  </script>
</body>

</html>